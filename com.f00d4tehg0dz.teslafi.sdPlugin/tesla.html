<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title id="title">Tesla Status</title>
    <link rel="stylesheet" href="css/sdpi.css">
    <script src="js/jquery-3.3.1.js"></script>
    <script src="js/common.js"></script>
</head>
<body>
<div class="sdpi-wrapper">
    <div class="sdpi-item">
        <div class="sdpi-item-label" id="apiProviderLabel">API Provider</div>
        <select class="sdpi-item-value select" id="apiProvider">
            <option value="teslafi">TeslaFi</option>
            <option value="teslamate">TeslaMate</option>
        </select>
    </div>
    <div class="sdpi-item" id="apiKeyContainer">
        <div class="sdpi-item-label" id="apiKeyLabel">API Key</div>
        <input class="sdpi-item-value" id="apiKey" required>
    </div>
    <div class="sdpi-item" id="teslamateUrlContainer" style="display: none;">
        <div class="sdpi-item-label" id="teslamateUrlLabel" aria-placeholder="ex 192.168.xx.xx">TeslaMate URL</div>
        <input class="sdpi-item-value" id="teslamateUrl" placeholder="ex 192.168.xx.xx" required>
    </div>
    <div class="sdpi-item" id="mqttUsernameContainer" style="display: none;">
        <div class="sdpi-item-label" id="mqttUsernameLabel">MQTT Username (Optional)</div>
        <input class="sdpi-item-value" id="mqttUsername">
    </div>
    <div class="sdpi-item" id="mqttPasswordContainer" style="display: none;">
        <div class="sdpi-item-label" id="mqttPasswordLabel">MQTT Password (Optional)</div>
        <input class="sdpi-item-value" id="mqttPassword" type="password">
    </div>
    <div class="sdpi-item" id="vehicleContainer" style="display: none;">
        <div class="sdpi-item-label" id="vehicleLabel">Vehicle</div>
        <select class="sdpi-item-value select" id="vehicle">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
        </select>
    </div>
    <div class="sdpi-item" id="apiKeyValidationMessage" style="display: none">
        <details class="message caution">
            <summary id="apiKeyRequiredMessage">API is required. Please check the instructions to see how you can obtain it.</summary>
        </details>
    </div>
    <div type="checkbox" class="sdpi-item">
        <div class="sdpi-item-label" id="automaticRefreshLabel">Automatic Refresh </div>
        <input class="sdpi-item-value" id="automaticRefresh" type="checkbox">
        <label for="automaticRefresh"><span></span></label>
    </div>
    <div class="sdpi-item">
        <div class="sdpi-item-label" id="temperatureUnitLabel">Temperature Unit</div>
        <select class="sdpi-item-value select" id="degreeType">
            <option value="0">F</option>
            <option value="1">C</option>
        </select>
    </div>
    <div class="sdpi-item">
        <div class="sdpi-item-label" id="distanceUnitLabel">Distance Unit</div>
        <select class="sdpi-item-value select" id="distanceType">
            <option value="0">Mi</option>
            <option value="1">Km</option>
        </select>
    </div>
    <div class="sdpi-item" id="batteryRangeTypeContainer" style="display: none;">
        <div class="sdpi-item-label" id="batteryRangeTypeLabel">Battery Range Type</div>
        <select class="sdpi-item-value select" id="batteryRangeType">
            <option value="ideal">Ideal</option>
            <option value="rated">Rated</option>
        </select>
    </div>
    <div class="sdpi-item">
        <div class="sdpi-item-label" id="field1Label">Field 1</div>
        <select class="sdpi-item-value select" id="field1">
            <option value="display_name">Car Name</option>
            <option value="inside_temp">Inside Temp</option>
            <option value="battery_range">Battery Range</option>
            <option value="battery_level">Battery Level</option>
            <option value="charging_state">Charging State</option>
            <option value="outside_temp">Outside Temp</option>
            <option value="odometer">Odometer</option>
            <option value="est_battery_range">Est. Battery Range</option>
        </select>
    </div>
    <div class="sdpi-item">
        <div class="sdpi-item-label" id="field2Label">Field 2</div>
        <select class="sdpi-item-value select" id="field2">
            <option value="display_name">Car Name</option>
            <option value="inside_temp">Inside Temp</option>
            <option value="battery_range">Battery Range</option>
            <option value="battery_level">Battery Level</option>
            <option value="charging_state">Charging State</option>
            <option value="outside_temp">Outside Temp</option>
            <option value="odometer">Odometer</option>
            <option value="est_battery_range">Est. Battery Range</option>
        </select>
    </div>
    <div class="sdpi-item">
        <div class="sdpi-item-label" id="field3Label">Field 3</div>
        <select class="sdpi-item-value select" id="field3">
            <option value="display_name">Car Name</option>
            <option value="inside_temp">Inside Temp</option>
            <option value="battery_range">Battery Range</option>
            <option value="battery_level">Battery Level</option>
            <option value="charging_state">Charging State</option>
            <option value="outside_temp">Outside Temp</option>
            <option value="odometer">Odometer</option>
            <option value="est_battery_range">Est. Battery Range</option>
        </select>
    </div>
    <div class="sdpi-item">
        <div class="sdpi-item-label" id="field4Label">Field 4</div>
        <select class="sdpi-item-value select" id="field4">
            <option value="display_name">Car Name</option>
            <option value="inside_temp">Inside Temp</option>
            <option value="battery_range">Battery Range</option>
            <option value="battery_level">Battery Level</option>
            <option value="charging_state">Charging State</option>
            <option value="outside_temp">Outside Temp</option>
            <option value="odometer">Odometer</option>
            <option value="est_battery_range">Est. Battery Range</option>
        </select>
    </div>
    <div class="sdpi-item">
        <div class="sdpi-item-label" id="field5Label">Field 5</div>
        <select class="sdpi-item-value select" id="field5">
            <option value="display_name">Car Name</option>
            <option value="inside_temp">Inside Temp</option>
            <option value="battery_range">Battery Range</option>
            <option value="battery_level">Battery Level</option>
            <option value="charging_state">Charging State</option>
            <option value="outside_temp">Outside Temp</option>
            <option value="odometer">Odometer</option>
            <option value="est_battery_range">Est. Battery Range</option>
        </select>
    </div>
    <div class="sdpi-item">
        <div class="sdpi-item-label" id="instructionsLabel">Instructions</div>
        <details class="sdpi-item-value">
            <p id="instructionsText">
                <br>Select between TeslaFi or TeslaMate to begin viewing your Tesla vehicle data!
                <br>TeslaFi requires the API key provided by TeslaFi, while TeslaMate requires your Websocket URL such as 192.168.xxx.xxx. <strong>Do note port is already provided as 9001</strong>.
                <br>If you do not have websockets enabled for TeslaMate please go ahead and edit your no-auth.conf to enable websockets.
                <br>You can learn more about this plugin and how to obtain an API key by visiting its Github page by <a href="#" onclick="openGithub()">clicking here.</a></p>
        </details>
    </div>
    <div class="sdpi-item">
        <button class="sdpi-item-value" id="updateButton">Update</button>
    </div>
</div>

<script>
    let uuid = "", actionName = "";

    $.getJSON("en.json", function(data) {
        $("#title").text(data.title);
        $("#apiProviderLabel").text(data.api_provider_label);
        $("#apiKeyLabel").text(data.api_key_label);
        $("#teslamateUrlLabel").text(data.teslamate_url_label);
        $("#mqttUsernameLabel").text(data.mqtt_username_label);
        $("#mqttPasswordLabel").text(data.mqtt_password_label);
        $("#apiKeyRequiredMessage").text(data.api_key_required_message);
        $("#automaticRefreshLabel").text(data.automatic_refresh_label);
        $("#temperatureUnitLabel").text(data.temperature_unit_label);
        $("#distanceUnitLabel").text(data.distance_unit_label);
        $("#batteryRangeTypeLabel").text(data.battery_range_type_label);
        $("#updateButton").text(data.update_button_text);
        $("#vehicleLabel").text(data.vehicle_label);
        $("#field1Label").text(data.field_1_label);
        $("#field2Label").text(data.field_2_label);
        $("#field3Label").text(data.field_3_label);
        $("#field4Label").text(data.field_4_label);
        $("#field5Label").text(data.field_5_label);
        $("#instructionsLabel").text(data.instructions_label);
        $("#instructionsText").html(`${data.instructions_text}<a href="#" onclick="openGithub()">${data.instructions_link_text}</a>`);
        const fieldOptions = data.field_options;
        for (const [key, value] of Object.entries(fieldOptions)) {
            $(`#field1 option[value=${key}]`).text(value);
            $(`#field2 option[value=${key}]`).text(value);
            $(`#field3 option[value=${key}]`).text(value);
            $(`#field4 option[value=${key}]`).text(value);
            $(`#field5 option[value=${key}]`).text(value);
        }
        $("#updateButton").text(data.update_button_text);
    });

    $(document).ready(function () {
        if ($SD) {
            $SD.on('connected', function (jsonObj) {
                uuid = jsonObj.uuid;
                if (jsonObj.hasOwnProperty('actionInfo')) {
                    actionName = jsonObj.actionInfo.action;
                }
                const settings = jsonObj.actionInfo.payload.settings;

                if (settings.apiProvider) {
                    $("#apiProvider").val(settings.apiProvider);
                    if (settings.apiProvider === "teslamate") {
                        $("#teslamateUrlContainer").show();
                        $("#mqttUsernameContainer").show();
                        $("#mqttPasswordContainer").show();
                        $("#batteryRangeTypeContainer").show();
                        $("#vehicleContainer").show();
                        $("#apiKeyContainer").hide();
                    } else {
                        $("#teslamateUrlContainer").hide();
                        $("#mqttUsernameContainer").hide();
                        $("#mqttPasswordContainer").hide();
                        $("#batteryRangeTypeContainer").hide();
                        $("#vehicleContainer").hide();
                        $("#apiKeyContainer").show();
                    }
                }
                if (settings.apiKey) {
                    $("#apiKey").val(settings.apiKey);
                }
                if (settings.teslamateUrl) {
                    $("#teslamateUrl").val(settings.teslamateUrl);
                }
                if (settings.mqttUsername) {
                    $("#mqttUsername").val(settings.mqttUsername);
                }
                if (settings.mqttPassword) {
                    $("#mqttPassword").val(settings.mqttPassword);
                }
                if (settings.degreeType) {
                    $("#degreeType").val(settings.degreeType);
                }
                if (settings.distanceType) {
                    $("#distanceType").val(settings.distanceType);
                }
                if (settings.automaticRefresh) {
                    $("#automaticRefresh").prop("checked", true);
                }
                if (settings.batteryRangeType) {
                    $("#batteryRangeType").val(settings.batteryRangeType);
                }
                if (settings.vehicle) {
                    $("#vehicle").val(settings.vehicle);
                }
                if (settings.fields) {
                    $("#field1").val(settings.fields[0]);
                    $("#field2").val(settings.fields[1]);
                    $("#field3").val(settings.fields[2]);
                    $("#field4").val(settings.fields[3]);
                    $("#field5").val(settings.fields[4]);
                }
            });
        }

        $("#apiKey").on("blur", function () {
            if (!$("#apiKey").val() && $("#apiProvider").val() === "teslafi") {
                $("#apiKeyValidationMessage").show();
            } else {
                $("#apiKeyValidationMessage").hide();
            }
        });

        $("#apiProvider").on("change", function () {
            if ($(this).val() === "teslamate") {
                $("#teslamateUrlContainer").show();
                $("#mqttUsernameContainer").show();
                $("#mqttPasswordContainer").show();
                $("#batteryRangeTypeContainer").show();
                $("#vehicleContainer").show();
                $("#apiKeyContainer").hide();
            } else {
                $("#teslamateUrlContainer").hide();
                $("#mqttUsernameContainer").hide();
                $("#mqttPasswordContainer").hide();
                $("#batteryRangeTypeContainer").hide();
                $("#vehicleContainer").hide();
                $("#apiKeyContainer").show();
            }
        });

        $("#updateButton").click(function () {
            if ($("#apiProvider").val() === "teslafi" && !$("#apiKey").val()) return;

            const payload = {
                apiProvider: $("#apiProvider").val(),
                apiKey: $("#apiKey").val(),
                teslamateUrl: $("#teslamateUrl").val(),
                mqttUsername: $("#mqttUsername").val(),
                mqttPassword: $("#mqttPassword").val(),
                batteryRangeType: $("#batteryRangeType").val(),
                automaticRefresh: $("#automaticRefresh").prop("checked"),
                degreeType: parseInt($("#degreeType").val()),
                distanceType: parseInt($("#distanceType").val()),
                vehicle: $("#vehicle").val(),
                fields: [
                    $("#field1").val(),
                    $("#field2").val(),
                    $("#field3").val(),
                    $("#field4").val(),
                    $("#field5").val()
                ]
            };

            if ($SD && $SD.connection) {
                $SD.api.sendToPlugin(uuid, actionName, payload);
            }
        });
    });

    function openGithub() {
        $SD.api.openUrl($SD.actionInfo.context, "https://github.com/f00d4tehg0dz/Teslafi-Status-Plugin-for-Eglato-Streamdeck");
    }
</script>

</body>
</html>